<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinySA ìŠ¤í™íŠ¸ëŸ¼ ë¶„ì„ê¸° ì‹œë®¬ë ˆì´í„°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(45deg, #4a6cf7, #667eea);
            border-radius: 15px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .control-panel {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e1e8ff;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #4a5568;
            font-size: 14px;
        }

        .control-group input, .control-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ff;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #4a6cf7;
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4a6cf7, #667eea);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 108, 247, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        .chart-container {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e1e8ff;
        }

        .chart-wrapper {
            position: relative;
            height: 500px;
        }

        .signal-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .signal-group {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #bee3f8;
        }

        .signal-group h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .marker-info {
            background: linear-gradient(45deg, #ffd89b, #19547b);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .marker-info h3 {
            margin-bottom: 10px;
        }

        .status-bar {
            background: #2d3748;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: monospace;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .unit-label {
            background: #e1e8ff;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            color: #4a5568;
            display: flex;
            align-items: center;
        }

        .status-indicator {
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .status-indicator.connected {
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
        }

        .status-indicator.disconnected {
            background: linear-gradient(45deg, #f56565, #e53e3e);
            color: white;
        }

        .status-indicator.connecting {
            background: linear-gradient(45deg, #ed8936, #dd6b20);
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .command-log {
            background: #2d3748;
            color: #68d391;
            font-family: monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 8px;
            height: 150px;
            overflow-y: auto;
            margin-top: 15px;
            border: 2px solid #4a5568;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .signal-controls {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¬ TinySA ìŠ¤í™íŠ¸ëŸ¼ ë¶„ì„ê¸°</h1>
            <p>RF ì‹ í˜¸ ë¶„ì„ ë° ì‹œë®¬ë ˆì´ì…˜ ë„êµ¬</p>
        </div>

        <div class="controls-grid">
            <div class="control-panel">
                <h2>ğŸ”Œ ì¥ë¹„ ì—°ê²°</h2>
                
                <div class="control-group">
                    <label>ì—°ê²° ìƒíƒœ</label>
                    <div id="connectionStatus" class="status-indicator disconnected">ì—°ê²° ì•ˆë¨</div>
                </div>

                <div class="control-group">
                    <label>ì¥ë¹„ ëª¨ë“œ</label>
                    <select id="deviceMode">
                        <option value="simulation">ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ</option>
                        <option value="hardware">ì‹¤ì œ ì¥ë¹„ ì—°ê²°</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>ë³´ë“œë ˆì´íŠ¸ (bps)</label>
                    <select id="baudRate">
                        <option value="auto">ìë™ ê°ì§€ (ê¶Œì¥)</option>
                        <option value="9600" selected>9600 (ì‹œìŠ¤í…œ ê¸°ë³¸)</option>
                        <option value="19200">19200</option>
                        <option value="38400">38400</option>
                        <option value="57600">57600</option>
                        <option value="115200">115200 (tinySA í‘œì¤€)</option>
                        <option value="230400">230400</option>
                    </select>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" id="connectBtn" onclick="connectDevice()">ğŸ”Œ ì¥ë¹„ ì—°ê²°</button>
                    <button class="btn btn-secondary" id="disconnectBtn" onclick="disconnectDevice()" disabled>âŒ ì—°ê²° í•´ì œ</button>
                </div>

                <div class="button-group" style="margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="diagnoseConnection()" id="diagnoseBtn" disabled>ğŸ” ì—°ê²° ì§„ë‹¨</button>
                    <button class="btn btn-secondary" onclick="clearLog()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
                </div>

                <div class="button-group" style="margin-top: 10px;">
                    <button class="btn btn-primary" onclick="quickReconnect()" id="reconnectBtn" disabled>ğŸ”„ ë¹ ë¥¸ ì¬ì—°ê²°</button>
                    <button class="btn btn-secondary" onclick="resetConnection()">ğŸ”§ ì—°ê²° ë¦¬ì…‹</button>
                </div>

                <div class="button-group" style="margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="fullDiagnosis()">ğŸ”¬ ì „ì²´ ì§„ë‹¨</button>
                    <button class="btn btn-secondary" onclick="monitorRawData()">ğŸ“¡ ì›ì‹œ ë°ì´í„° ëª¨ë‹ˆí„°</button>
                </div>

                <div class="button-group" style="margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="checkUSBDevices()">ğŸ” USB ì¥ì¹˜ í™•ì¸</button>
                    <button class="btn btn-secondary" onclick="fixPortIssues()">ğŸ”§ í¬íŠ¸ ë¬¸ì œ í•´ê²°</button>
                </div>

                <hr style="margin: 20px 0; border: 1px solid #e1e8ff;">

                <h2>ğŸ“¡ ì£¼íŒŒìˆ˜ ì„¤ì •</h2>
                
                <div class="control-group">
                    <label>ì‹œì‘ ì£¼íŒŒìˆ˜</label>
                    <div class="input-group">
                        <input type="number" id="startFreq" value="1" step="0.1">
                        <span class="unit-label">MHz</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>ì¢…ë£Œ ì£¼íŒŒìˆ˜</label>
                    <div class="input-group">
                        <input type="number" id="stopFreq" value="900" step="0.1">
                        <span class="unit-label">MHz</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>ìŠ¤ìº” í¬ì¸íŠ¸</label>
                    <select id="scanPoints">
                        <option value="101">101</option>
                        <option value="201">201</option>
                        <option value="301">301</option>
                        <option value="501">501</option>
                        <option value="801">801</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>RBW (Resolution Bandwidth)</label>
                    <select id="rbw">
                        <option value="auto">Auto</option>
                        <option value="1">1 kHz</option>
                        <option value="3">3 kHz</option>
                        <option value="10">10 kHz</option>
                        <option value="30">30 kHz</option>
                        <option value="100">100 kHz</option>
                    </select>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="startScan()">ğŸ” ìŠ¤ìº” ì‹œì‘</button>
                    <button class="btn btn-secondary" onclick="downloadCSV()">ğŸ’¾ CSV ì €ì¥</button>
                </div>

                <div class="marker-info">
                    <h3>ğŸ“ ë§ˆì»¤ ì •ë³´</h3>
                    <div id="markerInfo">í´ë¦­ìœ¼ë¡œ ë§ˆì»¤ ì„¤ì •</div>
                </div>

                <div class="control-group">
                    <label>ëª…ë ¹ì–´ ë¡œê·¸</label>
                    <div id="commandLog" class="command-log">ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ...\n</div>
                </div>
            </div>

            <div class="chart-container">
                <h2>ğŸ“Š ìŠ¤í™íŠ¸ëŸ¼ ë¶„ì„</h2>
                <div class="chart-wrapper">
                    <canvas id="spectrumChart"></canvas>
                </div>
            </div>
        </div>

        <div class="signal-controls">
            <div class="signal-group">
                <h3>ğŸ¯ ì‹ í˜¸ 1 ì„¤ì •</h3>
                <div class="control-group">
                    <label>ì£¼íŒŒìˆ˜ (MHz)</label>
                    <input type="number" id="signal1Freq" value="100" step="0.1">
                </div>
                <div class="control-group">
                    <label>ì§„í­ (dBm)</label>
                    <input type="number" id="signal1Amp" value="-20" step="1">
                </div>
                <div class="control-group">
                    <label>ì‹ í˜¸ íƒ€ì…</label>
                    <select id="signal1Type">
                        <option value="sine">ì‚¬ì¸íŒŒ</option>
                        <option value="square">êµ¬í˜•íŒŒ</option>
                        <option value="noise">ë…¸ì´ì¦ˆ</option>
                    </select>
                </div>
            </div>

            <div class="signal-group">
                <h3>ğŸ¯ ì‹ í˜¸ 2 ì„¤ì •</h3>
                <div class="control-group">
                    <label>ì£¼íŒŒìˆ˜ (MHz)</label>
                    <input type="number" id="signal2Freq" value="200" step="0.1">
                </div>
                <div class="control-group">
                    <label>ì§„í­ (dBm)</label>
                    <input type="number" id="signal2Amp" value="-30" step="1">
                </div>
                <div class="control-group">
                    <label>ì‹ í˜¸ íƒ€ì…</label>
                    <select id="signal2Type">
                        <option value="sine">ì‚¬ì¸íŒŒ</option>
                        <option value="square">êµ¬í˜•íŒŒ</option>
                        <option value="noise">ë…¸ì´ì¦ˆ</option>
                    </select>
                </div>
            </div>

            <div class="signal-group">
                <h3>ğŸ”§ ê³ ê¸‰ ì„¤ì •</h3>
                <div class="control-group">
                    <label>ì¶œë ¥ ë ˆë²¨ (dBm)</label>
                    <input type="number" id="outputLevel" value="-10" step="1">
                </div>
                <div class="control-group">
                    <label>ì¶œë ¥ ëª¨ë“œ</label>
                    <select id="outputMode">
                        <option value="off">OFF</option>
                        <option value="on">ON</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>ì…ë ¥ ëª¨ë“œ</label>
                    <select id="inputMode">
                        <option value="low">Low Input</option>
                        <option value="high">High Input</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="applyAdvancedSettings()" style="width: 100%; margin-top: 10px;">âš™ï¸ ì„¤ì • ì ìš©</button>
            </div>

            <div class="signal-group">
                <h3>ğŸ”Š ë…¸ì´ì¦ˆ & ìƒíƒœ</h3>
                <div class="control-group">
                    <label>ë…¸ì´ì¦ˆ ë ˆë²¨ (dBm)</label>
                    <input type="number" id="noiseLevel" value="-80" step="1">
                </div>
                <div class="control-group">
                    <label>ì˜¨ë„ (Â°C)</label>
                    <input type="number" id="temperature" value="25" step="1" readonly>
                </div>
                <button class="btn btn-secondary" onclick="getTemperature()" style="width: 100%; margin-top: 10px;">ğŸŒ¡ï¸ ì˜¨ë„ ì¸¡ì •</button>
            </div>
        </div>

        <div class="status-bar">
            <div id="statusDisplay">ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ - ìŠ¤ìº”ì„ ì‹œì‘í•˜ì„¸ìš”</div>
        </div>

        <div class="control-panel" style="margin-top: 20px;">
            <h2>ğŸš¨ USB ì¸ì‹ ë¬¸ì œ í•´ê²°</h2>
            <div style="background: #f8f9ff; padding: 15px; border-radius: 10px; font-size: 14px; line-height: 1.6;">
                <div style="background: #d4edda; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                    <strong>âœ… í˜„ì¬ ìƒí™© ë¶„ì„:</strong><br>
                    â€¢ ì—ëŸ¬ ë©”ì‹œì§€: "Chooser dialog blocked by Serial blocklist"<br>
                    â€¢ ì°¨ë‹¨ëœ ì¥ì¹˜: "ì§„ìš±ì˜ AirPods Pro" (ë¸”ë£¨íˆ¬ìŠ¤)<br>
                    â€¢ <strong>ì‹¤ì œ ë¬¸ì œ: tinySA USB ì¥ì¹˜ê°€ ì‹œìŠ¤í…œì—ì„œ ì¸ì‹ë˜ì§€ ì•ŠìŒ</strong>
                </div>

                <strong>ğŸ”§ ì¦‰ì‹œ í•´ê²° ë°©ë²• (ìš°ì„ ìˆœìœ„ ìˆœ):</strong><br>
                
                <div style="margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 5px;">
                    <strong>1ï¸âƒ£ USB ì¼€ì´ë¸” êµì²´ (ê°€ì¥ ì¤‘ìš”)</strong><br>
                    â€¢ í˜„ì¬ ì¼€ì´ë¸”ì´ <strong>ì¶©ì „ ì „ìš©</strong>ì¼ ê°€ëŠ¥ì„± ë†’ìŒ<br>
                    â€¢ <strong>ë°ì´í„° ì „ì†¡ìš©</strong> USB-A to USB-C ë˜ëŠ” USB-A to Micro-USB ì¼€ì´ë¸” ì‚¬ìš©<br>
                    â€¢ ìŠ¤ë§ˆíŠ¸í° ë°ì´í„° ì¼€ì´ë¸” ë˜ëŠ” ì™¸ì¥í•˜ë“œ ì¼€ì´ë¸” ì‚¬ìš© ê¶Œì¥<br>
                    â€¢ ì¼€ì´ë¸” ê¸¸ì´ëŠ” 1m ì´í•˜ë¡œ ì œí•œ
                </div>
                
                <div style="margin: 10px 0; padding: 10px; background: #d1ecf1; border-radius: 5px;">
                    <strong>2ï¸âƒ£ Windows ì¥ì¹˜ ê´€ë¦¬ì í™•ì¸</strong><br>
                    â€¢ <code>Win + X</code> â†’ <strong>ì¥ì¹˜ ê´€ë¦¬ì</strong> ì—´ê¸°<br>
                    â€¢ <strong>"í¬íŠ¸(COM ë° LPT)"</strong> ì„¹ì…˜ í™•ì¸<br>
                    â€¢ <strong>"USB Serial Port (COMx)"</strong> ë˜ëŠ” <strong>"STM32 Virtual ComPort"</strong> ì°¾ê¸°<br>
                    â€¢ ì—†ë‹¤ë©´ <strong>"ê¸°íƒ€ ì¥ì¹˜"</strong>ì—ì„œ ëŠë‚Œí‘œ(!) í‘œì‹œëœ ì¥ì¹˜ í™•ì¸<br>
                    â€¢ í•´ë‹¹ ì¥ì¹˜ ìš°í´ë¦­ â†’ <strong>"ë“œë¼ì´ë²„ ì—…ë°ì´íŠ¸"</strong> ì‹œë„
                </div>
                
                <div style="margin: 10px 0; padding: 10px; background: #f8d7da; border-radius: 5px;">
                    <strong>3ï¸âƒ£ USB í¬íŠ¸ ë³€ê²½</strong><br>
                    â€¢ <strong>USB 2.0 í¬íŠ¸</strong> ì‚¬ìš© (USB 3.0ë³´ë‹¤ ì•ˆì •ì )<br>
                    â€¢ <strong>ì»´í“¨í„° ë’·ë©´ì˜ USB í¬íŠ¸</strong> ìš°ì„  ì‚¬ìš©<br>
                    â€¢ USB í—ˆë¸Œ ì‚¬ìš© ê¸ˆì§€, <strong>ì§ì ‘ ì—°ê²°</strong><br>
                    â€¢ ë‹¤ë¥¸ USB ì¥ì¹˜ë“¤ì„ ë¶„ë¦¬í•˜ê³  í…ŒìŠ¤íŠ¸
                </div>

                <div style="margin: 10px 0; padding: 10px; background: #e2e3e5; border-radius: 5px;">
                    <strong>4ï¸âƒ£ tinySA ì¬ë¶€íŒ…</strong><br>
                    â€¢ tinySA ì „ì› ë²„íŠ¼ìœ¼ë¡œ <strong>ì™„ì „íˆ ì¢…ë£Œ</strong><br>
                    â€¢ <strong>10ì´ˆ ëŒ€ê¸°</strong> í›„ ë‹¤ì‹œ ì „ì› ì¼œê¸°<br>
                    â€¢ í™”ë©´ì— ì •ìƒì ì¸ ìŠ¤í™íŠ¸ëŸ¼ì´ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸<br>
                    â€¢ USB ì—°ê²° í›„ í™”ë©´ ë³€í™” í™•ì¸
                </div>

                <strong>ğŸ” ë¬¸ì œ í•´ê²° ìˆœì„œ:</strong><br>
                1. ìœ„ 1~4ë²ˆ ëª¨ë‘ ì‹œë„<br>
                2. <strong>"USB ì¥ì¹˜ í™•ì¸"</strong> ë²„íŠ¼ìœ¼ë¡œ ì‹œìŠ¤í…œ ìƒíƒœ ì ê²€<br>
                3. ì¥ì¹˜ ê´€ë¦¬ìì—ì„œ COM í¬íŠ¸ í™•ì¸ë¨ â†’ ë¸Œë¼ìš°ì €ì—ì„œ ì—°ê²° ì¬ì‹œë„<br>
                4. ì—¬ì „íˆ ì•ˆ ë˜ë©´ <strong>"í¬íŠ¸ ë¬¸ì œ í•´ê²°"</strong> ìƒì„¸ ê°€ì´ë“œ í™•ì¸<br><br>

                <strong>ğŸ’¡ ì„±ê³µ ì§€í‘œ:</strong><br>
                â€¢ ì¥ì¹˜ ê´€ë¦¬ìì— <strong>"USB Serial Port (COMìˆ«ì)"</strong> í‘œì‹œ<br>
                â€¢ ë¸Œë¼ìš°ì € í¬íŠ¸ ì„ íƒ ì‹œ <strong>AirPods ëŒ€ì‹  USB ì¥ì¹˜</strong> í‘œì‹œ<br>
                â€¢ ì—°ê²° ì‹œë„ ì‹œ <strong>ë¸”ë¡ë¦¬ìŠ¤íŠ¸ ì—ëŸ¬ ì—†ìŒ</strong>
            </div>
        </div>

        <div class="control-panel" style="margin-top: 20px;">
            <h2>ğŸ”§ ê³ ê¸‰ ë¬¸ì œ í•´ê²°</h2>
            <div style="background: #f8f9ff; padding: 15px; border-radius: 10px; font-size: 14px; line-height: 1.6;">
                <strong>Windows ê³ ê¸‰ í•´ê²°ë²•:</strong><br>
                
                <div style="margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 5px;">
                    <strong>ğŸ“‹ ìˆ˜ë™ ë“œë¼ì´ë²„ ì„¤ì¹˜:</strong><br>
                    1. ì¥ì¹˜ ê´€ë¦¬ìì—ì„œ <strong>ì•Œ ìˆ˜ ì—†ëŠ” ì¥ì¹˜</strong> ìš°í´ë¦­<br>
                    2. <strong>"ë“œë¼ì´ë²„ ì—…ë°ì´íŠ¸"</strong> â†’ <strong>"ì»´í“¨í„°ì—ì„œ ë“œë¼ì´ë²„ ì°¾ì•„ë³´ê¸°"</strong><br>
                    3. <strong>"ì»´í“¨í„°ì˜ ì‚¬ìš© ê°€ëŠ¥í•œ ë“œë¼ì´ë²„ ëª©ë¡ì—ì„œ ì„ íƒ"</strong><br>
                    4. <strong>"í¬íŠ¸(COM ë° LPT)"</strong> â†’ <strong>"USB Serial Port"</strong> ì„ íƒ
                </div>
                
                <div style="margin: 10px 0; padding: 10px; background: #d1ecf1; border-radius: 5px;">
                    <strong>âš¡ USB ì „ì› ê´€ë¦¬ í•´ì œ:</strong><br>
                    1. ì œì–´íŒ â†’ <strong>ì „ì› ì˜µì…˜</strong> â†’ <strong>ê³ ê¸‰ ì „ì› ì„¤ì •</strong><br>
                    2. <strong>"USB ì„¤ì •"</strong> â†’ <strong>"USB ì„ íƒì  ì¼ì‹œ ì¤‘ë‹¨ ì„¤ì •"</strong><br>
                    3. <strong>"ì‚¬ìš© ì•ˆ í•¨"</strong>ìœ¼ë¡œ ë³€ê²½ í›„ ì €ì¥
                </div>

                <strong>ëŒ€ì²´ ì—°ê²° ë°©ë²•:</strong><br>
                â€¢ <strong>ë‹¤ë¥¸ ì»´í“¨í„°ì—ì„œ í…ŒìŠ¤íŠ¸</strong> (í•˜ë“œì›¨ì–´ ë¬¸ì œ í™•ì¸ìš©)<br>
                â€¢ <strong>tinySA ê³µì‹ ì†Œí”„íŠ¸ì›¨ì–´</strong>ë¡œ ì—°ê²° í…ŒìŠ¤íŠ¸<br>
                â€¢ <strong>í„°ë¯¸ë„ í”„ë¡œê·¸ë¨</strong> (PuTTY, Tera Term)ìœ¼ë¡œ ì§ì ‘ ì—°ê²° ì‹œë„<br>
                â€¢ <strong>Arduino IDE Serial Monitor</strong>ë¡œ í…ŒìŠ¤íŠ¸
            </div>
        </div>
    </div>

    <script>
        let chart;
        let spectrumData = [];
        let frequencies = [];
        let isScanning = false;
        let serialPort = null;
        let reader = null;
        let writer = null;
        let isConnected = false;

        // tinySA ì¥ë¹„ ì‹ë³„ì
        const TINYSA_VID = 0x0483; // 1155
        const TINYSA_PID = 0x5740; // 22336

        // ìŠ¬ë¦½ í•¨ìˆ˜ (ìµœìƒë‹¨ì— ì •ì˜)
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜ (ì½˜ì†”ê³¼ UI ëª¨ë‘)
        function logCommand(message) {
            const logElement = document.getElementById('commandLog');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            
            // UIì— ë¡œê·¸ ì¶”ê°€
            logElement.textContent += logMessage + '\n';
            logElement.scrollTop = logElement.scrollHeight;
            
            // ë¸Œë¼ìš°ì € ì½˜ì†”ì—ë„ ë¡œê·¸ (ë””ë²„ê¹…ìš©)
            if (message.includes('âŒ') || message.includes('ì˜¤ë¥˜') || message.includes('ì‹¤íŒ¨')) {
                console.error('tinySA:', message);
            } else if (message.includes('âš ï¸') || message.includes('ê²½ê³ ')) {
                console.warn('tinySA:', message);
            } else if (message.includes('âœ…') || message.includes('ì„±ê³µ')) {
                console.log('tinySA:', message);
            } else {
                console.info('tinySA:', message);
            }
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const diagnoseBtn = document.getElementById('diagnoseBtn');
            const reconnectBtn = document.getElementById('reconnectBtn');
            
            statusElement.className = `status-indicator ${status}`;
            
            switch(status) {
                case 'connected':
                    statusElement.textContent = 'ì—°ê²°ë¨ âœ“';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    diagnoseBtn.disabled = false;
                    reconnectBtn.disabled = false;
                    isConnected = true;
                    break;
                case 'disconnected':
                    statusElement.textContent = 'ì—°ê²° ì•ˆë¨';
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    diagnoseBtn.disabled = true;
                    reconnectBtn.disabled = serialPort ? false : true; // ì´ì „ ì—°ê²° ì •ë³´ê°€ ìˆìœ¼ë©´ ì¬ì—°ê²° ê°€ëŠ¥
                    isConnected = false;
                    break;
                case 'connecting':
                    statusElement.textContent = 'ì—°ê²° ì¤‘...';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = true;
                    diagnoseBtn.disabled = true;
                    reconnectBtn.disabled = true;
                    break;
            }
            
            if (message) {
                logCommand(message);
            }
        }

        // ë¹ ë¥¸ ì¬ì—°ê²°
        async function quickReconnect() {
            if (!serialPort) {
                logCommand('âŒ ì´ì „ ì—°ê²° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ì—°ê²°í•˜ì„¸ìš”.');
                return;
            }

            try {
                logCommand('ğŸ”„ ë¹ ë¥¸ ì¬ì—°ê²° ì‹œë„...');
                updateConnectionStatus('connecting', 'ë¹ ë¥¸ ì¬ì—°ê²° ì¤‘...');
                
                // ê¸°ì¡´ ì—°ê²° ì •ë¦¬
                await cleanupConnection();
                
                // í˜„ì¬ ì„ íƒëœ ë³´ë“œë ˆì´íŠ¸ ì‚¬ìš©
                const selectedBaudRate = document.getElementById('baudRate').value;
                const baudRate = selectedBaudRate === 'auto' ? 9600 : parseInt(selectedBaudRate);
                
                logCommand(`ğŸ”§ ì¬ì—°ê²° ë³´ë“œë ˆì´íŠ¸: ${baudRate} bps`);
                
                // ì´ì „ê³¼ ê°™ì€ í¬íŠ¸ë¡œ ì¬ì—°ê²° ì‹œë„
                await serialPort.open({ 
                    baudRate: baudRate,
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none',
                    flowControl: 'none',
                    bufferSize: 255
                });

                reader = serialPort.readable.getReader();
                writer = serialPort.writable.getWriter();

                await sleep(300);
                
                const testResult = await quickConnectionTest();
                
                if (testResult) {
                    updateConnectionStatus('connected', `ë¹ ë¥¸ ì¬ì—°ê²° ì„±ê³µ! (${baudRate} bps)`);
                    await basicInitialize();
                } else {
                    throw new Error('í†µì‹  í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨');
                }
                
            } catch (error) {
                logCommand(`âŒ ë¹ ë¥¸ ì¬ì—°ê²° ì‹¤íŒ¨: ${error.message}`);
                updateConnectionStatus('disconnected', 'ë¹ ë¥¸ ì¬ì—°ê²° ì‹¤íŒ¨ - ìƒˆë¡œ ì—°ê²°í•˜ì„¸ìš”');
                await cleanupConnection();
            }
        }

        // ì—°ê²° ë¦¬ì…‹
        async function resetConnection() {
            try {
                logCommand('ğŸ”§ ì—°ê²° ë¦¬ì…‹ ì‹œì‘...');
                
                // ëª¨ë“  ì—°ê²° ì •ë³´ ì´ˆê¸°í™”
                await cleanupConnection();
                serialPort = null;
                reader = null;
                writer = null;
                
                updateConnectionStatus('disconnected', 'ì—°ê²°ì´ ì™„ì „íˆ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤');
                logCommand('âœ… ì—°ê²° ë¦¬ì…‹ ì™„ë£Œ - ìƒˆë¡œ ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
                
            } catch (error) {
                logCommand(`ë¦¬ì…‹ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // ì „ì²´ ì‹œìŠ¤í…œ ì§„ë‹¨
        async function fullDiagnosis() {
            logCommand('ğŸ”¬ === ì „ì²´ ì‹œìŠ¤í…œ ì§„ë‹¨ ì‹œì‘ ===');
            
            // 1. ë¸Œë¼ìš°ì € í™˜ê²½ ì ê²€
            logCommand('');
            logCommand('1ï¸âƒ£ ë¸Œë¼ìš°ì € í™˜ê²½ ì ê²€');
            logCommand(`   â€¢ ë¸Œë¼ìš°ì €: ${navigator.userAgent.split(' ').pop()}`);
            logCommand(`   â€¢ Web Serial API: ${('serial' in navigator) ? 'âœ… ì§€ì›ë¨' : 'âŒ ì§€ì› ì•ˆë¨'}`);
            logCommand(`   â€¢ HTTPS/localhost: ${(location.protocol === 'https:' || location.hostname === 'localhost') ? 'âœ… ì•ˆì „í•œ ì—°ê²°' : 'âš ï¸ ë³´ì•ˆ ì—°ê²° í•„ìš”'}`);
            
            // 2. ì‹œë¦¬ì–¼ í¬íŠ¸ ê¶Œí•œ í™•ì¸
            logCommand('');
            logCommand('2ï¸âƒ£ ì‹œë¦¬ì–¼ í¬íŠ¸ ê¶Œí•œ í™•ì¸');
            try {
                const ports = await navigator.serial.getPorts();
                logCommand(`   â€¢ ê¸°ì¡´ í—ˆìš©ëœ í¬íŠ¸: ${ports.length}ê°œ`);
                ports.forEach((port, index) => {
                    const info = port.getInfo();
                    logCommand(`     ${index+1}. VID=0x${info.usbVendorId?.toString(16) || '????'}, PID=0x${info.usbProductId?.toString(16) || '????'}`);
                });
                
                if (ports.length === 0) {
                    logCommand('   âš ï¸ í—ˆìš©ëœ í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. "ì¥ë¹„ ì—°ê²°" ë²„íŠ¼ìœ¼ë¡œ í¬íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                }
            } catch (error) {
                logCommand(`   âŒ í¬íŠ¸ ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨: ${error.message}`);
            }

            // 3. í˜„ì¬ ì—°ê²° ìƒíƒœ ë¶„ì„
            logCommand('');
            logCommand('3ï¸âƒ£ í˜„ì¬ ì—°ê²° ìƒíƒœ');
            logCommand(`   â€¢ ì—°ê²° ìƒíƒœ: ${isConnected ? 'âœ… ì—°ê²°ë¨' : 'âŒ ì—°ê²° ì•ˆë¨'}`);
            logCommand(`   â€¢ ì‹œë¦¬ì–¼ í¬íŠ¸: ${serialPort ? 'âœ… í¬íŠ¸ ê°ì²´ ì¡´ì¬' : 'âŒ í¬íŠ¸ ì—†ìŒ'}`);
            logCommand(`   â€¢ Reader: ${reader ? 'âœ… í™œì„±' : 'âŒ ë¹„í™œì„±'}`);
            logCommand(`   â€¢ Writer: ${writer ? 'âœ… í™œì„±' : 'âŒ ë¹„í™œì„±'}`);
            
            if (serialPort) {
                try {
                    const portInfo = serialPort.getInfo();
                    logCommand(`   â€¢ í¬íŠ¸ ì •ë³´: VID=0x${portInfo.usbVendorId?.toString(16)}, PID=0x${portInfo.usbProductId?.toString(16)}`);
                    logCommand(`   â€¢ í¬íŠ¸ ìƒíƒœ: ${serialPort.readable ? 'âœ… ì½ê¸° ê°€ëŠ¥' : 'âŒ ì½ê¸° ë¶ˆê°€'}`);
                    logCommand(`   â€¢ ì“°ê¸° ìƒíƒœ: ${serialPort.writable ? 'âœ… ì“°ê¸° ê°€ëŠ¥' : 'âŒ ì“°ê¸° ë¶ˆê°€'}`);
                } catch (error) {
                    logCommand(`   âŒ í¬íŠ¸ ì •ë³´ ì½ê¸° ì‹¤íŒ¨: ${error.message}`);
                }
            }

            // 4. ë³´ë“œë ˆì´íŠ¸ ë° ì„¤ì • í™•ì¸
            logCommand('');
            logCommand('4ï¸âƒ£ í†µì‹  ì„¤ì • í™•ì¸');
            const selectedBaudRate = document.getElementById('baudRate').value;
            logCommand(`   â€¢ ì„ íƒëœ ë³´ë“œë ˆì´íŠ¸: ${selectedBaudRate}`);
            logCommand(`   â€¢ ì¥ë¹„ ëª¨ë“œ: ${document.getElementById('deviceMode').value}`);

            // 5. ì—°ê²° í…ŒìŠ¤íŠ¸ (ì—°ê²°ëœ ê²½ìš°)
            if (isConnected && serialPort && reader && writer) {
                logCommand('');
                logCommand('5ï¸âƒ£ í†µì‹  í…ŒìŠ¤íŠ¸');
                await detailedConnectionTest();
            } else {
                logCommand('');
                logCommand('5ï¸âƒ£ í†µì‹  í…ŒìŠ¤íŠ¸');
                logCommand('   âš ï¸ ì¥ë¹„ê°€ ì—°ê²°ë˜ì§€ ì•Šì•„ í†µì‹  í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.');
                logCommand('   ğŸ’¡ ë¨¼ì € "ì¥ë¹„ ì—°ê²°" í›„ ì§„ë‹¨ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.');
            }

            // 6. ë¬¸ì œ í•´ê²° ì œì•ˆ
            logCommand('');
            logCommand('6ï¸âƒ£ ë¬¸ì œ í•´ê²° ì œì•ˆ');
            
            if (!('serial' in navigator)) {
                logCommand('   ğŸ”§ Chrome ê¸°ë°˜ ë¸Œë¼ìš°ì € ì‚¬ìš© í•„ìš”');
            } else if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                logCommand('   ğŸ”§ HTTPS ë˜ëŠ” localhostì—ì„œ ì‹¤í–‰ í•„ìš”');
            } else if (!isConnected) {
                logCommand('   ğŸ”§ ì—°ê²° ì‹œë„ ë‹¨ê³„:');
                logCommand('      1. tinySA ì „ì› í™•ì¸ ë° USB ì¼€ì´ë¸” êµì²´');
                logCommand('      2. ë³´ë“œë ˆì´íŠ¸ë¥¼ 9600ìœ¼ë¡œ ì„¤ì • í›„ ì—°ê²°');
                logCommand('      3. ì¥ì¹˜ ê´€ë¦¬ìì—ì„œ COM í¬íŠ¸ ìƒíƒœ í™•ì¸');
                logCommand('      4. ë‹¤ë¥¸ í”„ë¡œê·¸ë¨ì—ì„œ í¬íŠ¸ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸');
            } else {
                logCommand('   âœ… ì—°ê²° ìƒíƒœ ì •ìƒ');
            }

            logCommand('');
            logCommand('ğŸ”¬ === ì „ì²´ ì§„ë‹¨ ì™„ë£Œ ===');
        }

        // ìƒì„¸ ì—°ê²° í…ŒìŠ¤íŠ¸
        async function detailedConnectionTest() {
            try {
                logCommand('   ğŸ“¡ ê¸°ë³¸ í†µì‹  í™•ì¸...');
                
                // ë¹ˆ ëª…ë ¹ì–´ ì „ì†¡
                await writer.write(new TextEncoder().encode('\r'));
                const response1 = await readWithQuickTimeout(1000);
                logCommand(`      ì‘ë‹µ1: "${response1}" (ê¸¸ì´: ${response1.length})`);
                
                // ë‹¤ë¥¸ ëª…ë ¹ì–´ ì‹œë„
                await writer.write(new TextEncoder().encode('\r\n'));
                const response2 = await readWithQuickTimeout(1000);
                logCommand(`      ì‘ë‹µ2: "${response2}" (ê¸¸ì´: ${response2.length})`);
                
                // í”„ë¡¬í”„íŠ¸ íŒ¨í„´ ë¶„ì„
                const combinedResponse = response1 + response2;
                if (combinedResponse.includes('ch>')) {
                    logCommand('   âœ… tinySA í”„ë¡¬í”„íŠ¸ "ch>" ê°ì§€ë¨');
                } else if (combinedResponse.includes('>')) {
                    logCommand('   âœ… ì¼ë°˜ í”„ë¡¬í”„íŠ¸ ">" ê°ì§€ë¨');
                } else if (combinedResponse.length > 0) {
                    logCommand('   âš ï¸ ì‘ë‹µì€ ìˆì§€ë§Œ í”„ë¡¬í”„íŠ¸ íŒ¨í„´ ë¶ˆì¼ì¹˜');
                    logCommand(`      ìˆ˜ì‹  ë°ì´í„° ë¶„ì„: "${combinedResponse}"`);
                } else {
                    logCommand('   âŒ ì‘ë‹µ ì—†ìŒ - ë³´ë“œë ˆì´íŠ¸ ë˜ëŠ” ì¼€ì´ë¸” ë¬¸ì œ ê°€ëŠ¥ì„±');
                }
                
                // ASCII ì½”ë“œ ë¶„ì„
                if (combinedResponse.length > 0) {
                    const asciiCodes = Array.from(combinedResponse).map(char => char.charCodeAt(0));
                    logCommand(`      ASCII ì½”ë“œ: [${asciiCodes.join(', ')}]`);
                }
                
            } catch (error) {
                logCommand(`   âŒ í†µì‹  í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // ì›ì‹œ ë°ì´í„° ëª¨ë‹ˆí„°
        async function monitorRawData() {
            if (!isConnected || !reader) {
                alert('ë¨¼ì € ì¥ë¹„ë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.');
                return;
            }

            logCommand('ğŸ“¡ === ì›ì‹œ ë°ì´í„° ëª¨ë‹ˆí„° ì‹œì‘ ===');
            logCommand('â¹ï¸ ëª¨ë‹ˆí„° ì¤‘ì§€: í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë˜ëŠ” ì—°ê²° í•´ì œ');
            logCommand('');

            let monitorCount = 0;
            const maxMonitorTime = 30000; // 30ì´ˆ
            const startTime = Date.now();

            try {
                while (isConnected && (Date.now() - startTime) < maxMonitorTime) {
                    // ì£¼ê¸°ì ìœ¼ë¡œ ê°„ë‹¨í•œ ëª…ë ¹ì–´ ì „ì†¡
                    if (monitorCount % 5 === 0) {
                        await writer.write(new TextEncoder().encode('\r'));
                        logCommand(`[${monitorCount}] ëª…ë ¹ ì „ì†¡: "\\r"`);
                    }

                    // ë°ì´í„° ì½ê¸° ì‹œë„
                    try {
                        const readPromise = reader.read();
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('timeout')), 1000)
                        );
                        
                        const { value, done } = await Promise.race([readPromise, timeoutPromise]);
                        
                        if (done) {
                            logCommand('[Monitor] Reader ì¢…ë£Œë¨');
                            break;
                        }

                        if (value && value.length > 0) {
                            const text = new TextDecoder().decode(value);
                            const asciiCodes = Array.from(value).join(' ');
                            logCommand(`[${monitorCount}] ìˆ˜ì‹ : "${text}" | Bytes: [${asciiCodes}]`);
                        }
                        
                    } catch (error) {
                        if (error.message !== 'timeout') {
                            logCommand(`[${monitorCount}] ì½ê¸° ì˜¤ë¥˜: ${error.message}`);
                        }
                    }

                    monitorCount++;
                    await sleep(200);
                }

            } catch (error) {
                logCommand(`ğŸ“¡ ëª¨ë‹ˆí„° ì˜¤ë¥˜: ${error.message}`);
            }

            logCommand('');
            logCommand('ğŸ“¡ === ì›ì‹œ ë°ì´í„° ëª¨ë‹ˆí„° ì¢…ë£Œ ===');
        }

        // tinySA ì¥ë¹„ ì—°ê²° (ê°œì„ ëœ ì˜¤ë¥˜ ì²˜ë¦¬)
        async function connectDevice() {
            const deviceMode = document.getElementById('deviceMode').value;
            
            if (deviceMode === 'simulation') {
                updateConnectionStatus('connected', 'ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì—°ê²°ë¨');
                return;
            }

            if (!('serial' in navigator)) {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” Web Serial APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome ê¸°ë°˜ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                updateConnectionStatus('connecting', '1ë‹¨ê³„: í¬íŠ¸ ì„ íƒ ì¤‘...');
                
                // ì‹œë¦¬ì–¼ í¬íŠ¸ ìš”ì²­ (ê°œì„ ëœ ì˜¤ë¥˜ ì²˜ë¦¬)
                logCommand('ğŸ” ì‹œë¦¬ì–¼ í¬íŠ¸ ìš”ì²­ ì¤‘...');
                
                try {
                    serialPort = await navigator.serial.requestPort();
                } catch (portError) {
                    // íŠ¹ì • ì˜¤ë¥˜ ë©”ì‹œì§€ ë¶„ì„
                    if (portError.message.includes('blocklist') || portError.message.includes('blocked')) {
                        logCommand('âŒ í¬íŠ¸ ì„ íƒ ì‹¤íŒ¨: ë¸Œë¼ìš°ì €ê°€ ì¥ì¹˜ë¥¼ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤');
                        logCommand('ğŸ” ê°ì§€ëœ ë¬¸ì œ: USB ì¥ì¹˜ê°€ ì‹œë¦¬ì–¼ í¬íŠ¸ë¡œ ì¸ì‹ë˜ì§€ ì•ŠìŒ');
                        logCommand('');
                        logCommand('ğŸ’¡ ì´ ë¬¸ì œëŠ” ë‹¤ìŒ ì¤‘ í•˜ë‚˜ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:');
                        logCommand('   â€¢ tinySAê°€ USBë¡œ ì œëŒ€ë¡œ ì—°ê²°ë˜ì§€ ì•ŠìŒ');
                        logCommand('   â€¢ USB ì¼€ì´ë¸”ì´ ì¶©ì „ ì „ìš© (ë°ì´í„° ì „ì†¡ ë¶ˆê°€)');
                        logCommand('   â€¢ ì‹œìŠ¤í…œì—ì„œ tinySAë¥¼ ì¸ì‹í•˜ì§€ ëª»í•¨');
                        logCommand('   â€¢ USB ë“œë¼ì´ë²„ ë¬¸ì œ');
                        logCommand('');
                        logCommand('ğŸ”§ í•´ê²° ë°©ë²•:');
                        logCommand('   1. "USB ì¥ì¹˜ í™•ì¸" ë²„íŠ¼ìœ¼ë¡œ ì‹œìŠ¤í…œ ìƒíƒœ ì ê²€');
                        logCommand('   2. "í¬íŠ¸ ë¬¸ì œ í•´ê²°" ë²„íŠ¼ìœ¼ë¡œ ìƒì„¸ ê°€ì´ë“œ í™•ì¸');
                        logCommand('   3. USB ì¼€ì´ë¸”ì„ ë°ì´í„° ì „ì†¡ìš©ìœ¼ë¡œ êµì²´');
                        logCommand('   4. ì¥ì¹˜ ê´€ë¦¬ìì—ì„œ COM í¬íŠ¸ í™•ì¸');
                        
                        updateConnectionStatus('disconnected', 'í¬íŠ¸ ì„ íƒ ì‹¤íŒ¨ - USB ì¥ì¹˜ ë¬¸ì œ');
                        return;
                    } else if (portError.message.includes('No port selected')) {
                        logCommand('âš ï¸ ì‚¬ìš©ìê°€ í¬íŠ¸ ì„ íƒì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤');
                        updateConnectionStatus('disconnected', 'í¬íŠ¸ ì„ íƒ ì·¨ì†Œë¨');
                        return;
                    } else {
                        logCommand(`âŒ í¬íŠ¸ ì„ íƒ ì˜¤ë¥˜: ${portError.message}`);
                        updateConnectionStatus('disconnected', `í¬íŠ¸ ì„ íƒ ì‹¤íŒ¨: ${portError.message}`);
                        return;
                    }
                }

                const portInfo = serialPort.getInfo();
                logCommand(`âœ… í¬íŠ¸ ì„ íƒë¨: VID=0x${portInfo.usbVendorId?.toString(16) || '????'}, PID=0x${portInfo.usbProductId?.toString(16) || '????'}`);

                // tinySA ì¥ì¹˜ ì‹ë³„
                if (portInfo.usbVendorId === 0x0483 && portInfo.usbProductId === 0x5740) {
                    logCommand('ğŸ¯ tinySA ì¥ì¹˜ í™•ì¸ë¨! (VID=0x0483, PID=0x5740)');
                } else if (portInfo.usbVendorId === 0x0483) {
                    logCommand('âš ï¸ STM32 ê¸°ë°˜ ì¥ì¹˜ ê°ì§€ë¨ (tinySA ê°€ëŠ¥ì„± ë†’ìŒ)');
                } else {
                    logCommand('â“ ì•Œ ìˆ˜ ì—†ëŠ” ì¥ì¹˜ì…ë‹ˆë‹¤. ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤...');
                }

                const selectedBaudRate = document.getElementById('baudRate').value;
                let connectConfigs = [];

                if (selectedBaudRate === 'auto') {
                    // ìë™ ê°ì§€: 9600ë¶€í„° ì‹œì‘ (ì‹œìŠ¤í…œ ê¸°ë³¸ê°’ ìš°ì„ )
                    connectConfigs = [
                        { baudRate: 9600, name: 'ì‹œìŠ¤í…œ ê¸°ë³¸ (9600)' },
                        { baudRate: 115200, name: 'tinySA í‘œì¤€ (115200)' },
                        { baudRate: 19200, name: 'ì €ì† ì•ˆì • (19200)' },
                        { baudRate: 38400, name: 'ì¤‘ê°„ ì†ë„ (38400)' },
                        { baudRate: 57600, name: 'tinySA í˜¸í™˜ (57600)' },
                        { baudRate: 230400, name: 'ê³ ì† (230400)' }
                    ];
                } else {
                    // ì‚¬ìš©ì ì„ íƒ ë³´ë“œë ˆì´íŠ¸ ìš°ì„  ì‹œë„
                    const userBaudRate = parseInt(selectedBaudRate);
                    connectConfigs = [
                        { baudRate: userBaudRate, name: `ì‚¬ìš©ì ì„ íƒ (${userBaudRate})` }
                    ];
                    
                    // ì‹¤íŒ¨ ì‹œ ë‹¤ë¥¸ ë³´ë“œë ˆì´íŠ¸ë„ ì‹œë„
                    const backupRates = [9600, 115200, 19200, 38400, 57600, 230400]
                        .filter(rate => rate !== userBaudRate);
                    
                    backupRates.forEach(rate => {
                        connectConfigs.push({ baudRate: rate, name: `ë°±ì—… ì‹œë„ (${rate})` });
                    });
                }

                logCommand(`ğŸ”§ ë³´ë“œë ˆì´íŠ¸ ì„¤ì •: ${selectedBaudRate === 'auto' ? 'ìë™ ê°ì§€' : selectedBaudRate + ' bps'}`);

                for (let i = 0; i < connectConfigs.length; i++) {
                    const config = connectConfigs[i];
                    
                    try {
                        updateConnectionStatus('connecting', `${i+2}ë‹¨ê³„: ${config.name} ì—°ê²° ì¤‘...`);
                        logCommand(`ğŸ”„ ${config.name} ì—°ê²° ì‹œë„...`);
                        
                        // ì´ì „ ì—°ê²°ì´ ìˆë‹¤ë©´ ì •ë¦¬
                        await cleanupConnection();
                        
                        // í¬íŠ¸ ì—´ê¸°
                        await serialPort.open({ 
                            baudRate: config.baudRate,
                            dataBits: 8,
                            stopBits: 1,
                            parity: 'none',
                            flowControl: 'none',
                            bufferSize: 255
                        });

                        logCommand(`ğŸ“¡ í¬íŠ¸ ì—´ë¦¼ ì„±ê³µ (${config.baudRate} bps)`);
                        logCommand(`   â€¢ ë°ì´í„° ë¹„íŠ¸: 8, ì •ì§€ ë¹„íŠ¸: 1, íŒ¨ë¦¬í‹°: ì—†ìŒ`);
                        logCommand(`   â€¢ íë¦„ ì œì–´: ì—†ìŒ, ë²„í¼ í¬ê¸°: 255`);

                        // Readerì™€ Writer ì„¤ì •
                        reader = serialPort.readable.getReader();
                        writer = serialPort.writable.getWriter();
                        logCommand(`   â€¢ Reader/Writer ì„¤ì • ì™„ë£Œ`);

                        // ì—°ê²° ì•ˆì •í™” ëŒ€ê¸°
                        logCommand(`   â€¢ ì—°ê²° ì•ˆì •í™” ëŒ€ê¸° ì¤‘... (300ms)`);
                        await sleep(300);

                        // ê°„ë‹¨í•œ ì—°ê²° í…ŒìŠ¤íŠ¸
                        updateConnectionStatus('connecting', `${i+2}ë‹¨ê³„: í†µì‹  í…ŒìŠ¤íŠ¸ (${config.baudRate} bps)`);
                        const testResult = await quickConnectionTest();
                        
                        if (testResult) {
                            logCommand(`âœ… ì—°ê²° ì„±ê³µ! ${config.name}`);
                            updateConnectionStatus('connected', `tinySA ì—°ê²° ì™„ë£Œ (${config.baudRate} bps)`);
                            
                            // ê¸°ë³¸ ì´ˆê¸°í™”
                            await basicInitialize();
                            
                            // ì„±ê³µí•œ ë³´ë“œë ˆì´íŠ¸ë¥¼ UIì— ë°˜ì˜
                            if (selectedBaudRate === 'auto') {
                                document.getElementById('baudRate').value = config.baudRate.toString();
                                logCommand(`ğŸ’¡ ìë™ ê°ì§€ ì™„ë£Œ: ${config.baudRate} bpsë¡œ ì„¤ì •ë¨`);
                            }
                            
                            return;
                        } else {
                            logCommand(`âŒ í†µì‹  ì‹¤íŒ¨ (${config.baudRate} bps)`);
                        }

                    } catch (error) {
                        logCommand(`âŒ ${config.name} ì—°ê²° ì‹¤íŒ¨: ${error.message}`);
                        await cleanupConnection();
                    }
                    
                    // ì‚¬ìš©ì ì„ íƒ ë³´ë“œë ˆì´íŠ¸ê°€ ì‹¤íŒ¨í–ˆê³  ë°±ì—… ì‹œë„ì¸ ê²½ìš° ì§§ì€ ì§€ì—°
                    if (i === 0 && selectedBaudRate !== 'auto') {
                        logCommand(`â³ ì‚¬ìš©ì ì„ íƒ ë³´ë“œë ˆì´íŠ¸ ì‹¤íŒ¨, ë°±ì—… ë³´ë“œë ˆì´íŠ¸ë¡œ ì‹œë„...`);
                        await sleep(500);
                    }
                }

                throw new Error('ëª¨ë“  ë³´ë“œë ˆì´íŠ¸ì—ì„œ ì—°ê²° ì‹¤íŒ¨ - ì¥ë¹„ì™€ ì¼€ì´ë¸”ì„ í™•ì¸í•˜ì„¸ìš”');
                
            } catch (error) {
                updateConnectionStatus('disconnected', `ì—°ê²° ì‹¤íŒ¨: ${error.message}`);
                logCommand(`ğŸš¨ ìµœì¢… ì—°ê²° ì‹¤íŒ¨: ${error.message}`);
                
                // ì—°ê²° ì‹¤íŒ¨ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì œê³µ
                logCommand('');
                logCommand('ğŸ”§ === ì—°ê²° ì‹¤íŒ¨ ì²´í¬ë¦¬ìŠ¤íŠ¸ ===');
                logCommand('ë‹¤ìŒ í•­ëª©ë“¤ì„ ìˆœì„œëŒ€ë¡œ í™•ì¸í•´ë³´ì„¸ìš”:');
                logCommand('');
                logCommand('1ï¸âƒ£ USB ì—°ê²° ìƒíƒœ:');
                logCommand('   â–¡ ë°ì´í„° ì „ì†¡ìš© ì¼€ì´ë¸”ì¸ê°€? (ì¶©ì „ ì „ìš© âŒ)');
                logCommand('   â–¡ ì¼€ì´ë¸”ì„ ë‹¤ë¥¸ ê²ƒìœ¼ë¡œ êµì²´í•´ë´¤ëŠ”ê°€?');
                logCommand('   â–¡ USB í—ˆë¸Œ ì—†ì´ ì§ì ‘ ì—°ê²°í–ˆëŠ”ê°€?');
                logCommand('   â–¡ USB 2.0 í¬íŠ¸ë¥¼ ì‚¬ìš©í–ˆëŠ”ê°€?');
                logCommand('');
                logCommand('2ï¸âƒ£ tinySA ì¥ë¹„ ìƒíƒœ:');
                logCommand('   â–¡ ì „ì›ì´ ì¼œì ¸ ìˆê³  í™”ë©´ì´ ì •ìƒì¸ê°€?');
                logCommand('   â–¡ ì¥ë¹„ë¥¼ ê»ë‹¤ê°€ ë‹¤ì‹œ ì¼œë´¤ëŠ”ê°€?');
                logCommand('   â–¡ USB í¬íŠ¸ì— ì´ë¬¼ì§ˆì´ ì—†ëŠ”ê°€?');
                logCommand('');
                logCommand('3ï¸âƒ£ ì‹œìŠ¤í…œ ì¸ì‹ í™•ì¸:');
                logCommand('   â–¡ ì¥ì¹˜ ê´€ë¦¬ìì—ì„œ COM í¬íŠ¸ê°€ ë³´ì´ëŠ”ê°€?');
                logCommand('   â–¡ "USB ì¥ì¹˜ í™•ì¸" ë²„íŠ¼ìœ¼ë¡œ ì ê²€í–ˆëŠ”ê°€?');
                logCommand('   â–¡ ë‹¤ë¥¸ í”„ë¡œê·¸ë¨ì—ì„œ ê°™ì€ í¬íŠ¸ë¥¼ ì‚¬ìš© ì¤‘ì´ì§€ ì•Šì€ê°€?');
                logCommand('');
                logCommand('4ï¸âƒ£ ì¦‰ì‹œ í•´ê²° ë‹¨ê³„:');
                logCommand('   1. "USB ì¥ì¹˜ í™•ì¸" í´ë¦­');
                logCommand('   2. "í¬íŠ¸ ë¬¸ì œ í•´ê²°" í´ë¦­');
                logCommand('   3. USB ì¼€ì´ë¸” êµì²´ í›„ ì¬ì‹œë„');
                logCommand('   4. ì»´í“¨í„° ì¬ë¶€íŒ… í›„ ì¬ì‹œë„');
                
                await cleanupConnection();
            }
        }

        // ì—°ê²° ì •ë¦¬
        async function cleanupConnection() {
            try {
                if (reader) {
                    try { 
                        await reader.cancel();
                        await reader.releaseLock(); 
                    } catch (e) { 
                        logCommand(`Reader ì •ë¦¬ ì¤‘ ì˜¤ë¥˜: ${e.message}`);
                    }
                    reader = null;
                }
                
                if (writer) {
                    try { 
                        await writer.releaseLock(); 
                    } catch (e) { 
                        logCommand(`Writer ì •ë¦¬ ì¤‘ ì˜¤ë¥˜: ${e.message}`);
                    }
                    writer = null;
                }
                
                if (serialPort && serialPort.readable) {
                    try { 
                        await serialPort.close(); 
                    } catch (e) { 
                        logCommand(`í¬íŠ¸ ë‹«ê¸° ì¤‘ ì˜¤ë¥˜: ${e.message}`);
                    }
                }
            } catch (error) {
                logCommand(`ì •ë¦¬ ê³¼ì • ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // ë¹ ë¥¸ ì—°ê²° í…ŒìŠ¤íŠ¸
        async function quickConnectionTest() {
            try {
                logCommand('ğŸ”„ í†µì‹  í…ŒìŠ¤íŠ¸ ì‹œì‘...');
                
                // ë²„í¼ ì •ë¦¬
                await sleep(100);
                
                // 1ì°¨ í…ŒìŠ¤íŠ¸: ê°„ë‹¨í•œ ì—”í„° ì „ì†¡
                logCommand('   ğŸ“¤ 1ì°¨ í…ŒìŠ¤íŠ¸: CR ì „ì†¡');
                await writer.write(new TextEncoder().encode('\r'));
                
                const response1 = await readWithQuickTimeout(1500);
                logCommand(`   ğŸ“¥ 1ì°¨ ì‘ë‹µ: "${response1}" (ê¸¸ì´: ${response1.length})`);
                
                if (response1.length > 0) {
                    const asciiCodes = Array.from(response1).map(c => c.charCodeAt(0)).join(' ');
                    logCommand(`   ğŸ”¢ ASCII ì½”ë“œ: [${asciiCodes}]`);
                }
                
                // 2ì°¨ í…ŒìŠ¤íŠ¸: CRLF ì „ì†¡
                logCommand('   ğŸ“¤ 2ì°¨ í…ŒìŠ¤íŠ¸: CRLF ì „ì†¡');
                await writer.write(new TextEncoder().encode('\r\n'));
                
                const response2 = await readWithQuickTimeout(1000);
                logCommand(`   ğŸ“¥ 2ì°¨ ì‘ë‹µ: "${response2}" (ê¸¸ì´: ${response2.length})`);
                
                // ì‘ë‹µ ë¶„ì„
                const combinedResponse = response1 + response2;
                logCommand(`   ğŸ” ì¢…í•© ë¶„ì„: "${combinedResponse}"`);
                
                // tinySA í”„ë¡¬í”„íŠ¸ íŒ¨í„´ í™•ì¸
                if (combinedResponse.includes('ch>') || 
                    combinedResponse.includes('Ch>') || 
                    combinedResponse.includes('CH>')) {
                    logCommand('   âœ… tinySA í”„ë¡¬í”„íŠ¸ "ch>" í™•ì¸ë¨');
                    return true;
                } else if (combinedResponse.includes('>')) {
                    logCommand('   âœ… ì¼ë°˜ í”„ë¡¬í”„íŠ¸ ">" í™•ì¸ë¨ (tinySA ê°€ëŠ¥ì„± ë†’ìŒ)');
                    return true;
                } else if (combinedResponse.length > 0) {
                    logCommand('   âš ï¸ ì‘ë‹µì€ ìˆì§€ë§Œ í”„ë¡¬í”„íŠ¸ í˜•ì‹ ë‹¤ë¦„');
                    logCommand('   ğŸ’¡ ì¥ë¹„ê°€ ë‹¤ë¥¸ ëª¨ë“œì— ìˆê±°ë‚˜ ë‹¤ë¥¸ ê¸°ê¸°ì¼ ìˆ˜ ìˆìŒ');
                    
                    // ê·¸ë˜ë„ í†µì‹ ì€ ë˜ë¯€ë¡œ ì—°ê²° ì‹œë„
                    if (combinedResponse.length > 3) {
                        logCommand('   ğŸ”„ ì‘ë‹µì´ ì¶©ë¶„í•˜ë¯€ë¡œ ì—°ê²° ì‹œë„í•¨');
                        return true;
                    }
                    return false;
                } else {
                    logCommand('   âŒ ì‘ë‹µ ì—†ìŒ');
                    logCommand('   ğŸ”§ ê°€ëŠ¥í•œ ì›ì¸:');
                    logCommand('      â€¢ ë³´ë“œë ˆì´íŠ¸ ë¶ˆì¼ì¹˜');
                    logCommand('      â€¢ ì¼€ì´ë¸” ë¶ˆëŸ‰ (ì¶©ì „ ì „ìš©)');
                    logCommand('      â€¢ ì¥ë¹„ ì „ì› êº¼ì§');
                    logCommand('      â€¢ ë‹¤ë¥¸ í”„ë¡œê·¸ë¨ì—ì„œ í¬íŠ¸ ì‚¬ìš© ì¤‘');
                    return false;
                }
                
            } catch (error) {
                logCommand(`âŒ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
                logCommand('ğŸ”§ ì„¸ë¶€ ì˜¤ë¥˜ ì •ë³´:');
                logCommand(`   â€¢ ì˜¤ë¥˜ íƒ€ì…: ${error.constructor.name}`);
                logCommand(`   â€¢ ì˜¤ë¥˜ ìŠ¤íƒ: ${error.stack?.split('\n')[0] || 'ì •ë³´ ì—†ìŒ'}`);
                return false;
            }
        }

        // ë¹ ë¥¸ íƒ€ì„ì•„ì›ƒ ì½ê¸°
        async function readWithQuickTimeout(timeoutMs) {
            return new Promise(async (resolve, reject) => {
                let response = '';
                let completed = false;
                
                const timeout = setTimeout(() => {
                    if (!completed) {
                        completed = true;
                        resolve(response); // íƒ€ì„ì•„ì›ƒ ì‹œì—ë„ ê¸°ì¡´ ì‘ë‹µ ë°˜í™˜
                    }
                }, timeoutMs);
                
                try {
                    while (!completed) {
                        const readPromise = reader.read();
                        const { value, done } = await Promise.race([
                            readPromise,
                            new Promise((_, rej) => setTimeout(() => rej(new Error('read timeout')), 500))
                        ]);
                        
                        if (done || completed) break;
                        
                        const text = new TextDecoder().decode(value);
                        response += text;
                        
                        // ì¶©ë¶„í•œ ì‘ë‹µì´ ì™”ìœ¼ë©´ ì¡°ê¸° ì¢…ë£Œ
                        if (response.length > 10 || response.includes('>')) {
                            break;
                        }
                    }
                } catch (error) {
                    // ì½ê¸° ì˜¤ë¥˜ëŠ” ë¬´ì‹œí•˜ê³  ê¸°ì¡´ ì‘ë‹µ ë°˜í™˜
                }
                
                if (!completed) {
                    completed = true;
                    clearTimeout(timeout);
                    resolve(response);
                }
            });
        }

        // ê¸°ë³¸ ì´ˆê¸°í™”
        async function basicInitialize() {
            try {
                logCommand('ğŸ”§ ê¸°ë³¸ ì´ˆê¸°í™” ì‹œì‘...');
                
                // ì•ˆì „í•œ ê¸°ë³¸ ëª…ë ¹ì–´ë“¤
                await sleep(200);
                await safeCommand('resume', 1000);
                await sleep(200);
                
                logCommand('âœ… ê¸°ë³¸ ì´ˆê¸°í™” ì™„ë£Œ');
                
            } catch (error) {
                logCommand(`âš ï¸ ì´ˆê¸°í™” ê²½ê³ : ${error.message} (ì •ìƒ ë™ì‘ ê°€ëŠ¥)`);
            }
        }

        // ì•ˆì „í•œ ëª…ë ¹ì–´ ì „ì†¡
        async function safeCommand(command, timeoutMs = 2000) {
            try {
                logCommand(`ğŸ“¤ ëª…ë ¹: ${command}`);
                await writer.write(new TextEncoder().encode(command + '\r'));
                
                const response = await readWithQuickTimeout(timeoutMs);
                logCommand(`ğŸ“¥ ì‘ë‹µ: "${response}"`);
                
                return response;
            } catch (error) {
                logCommand(`âš ï¸ ëª…ë ¹ "${command}" ì˜¤ë¥˜: ${error.message}`);
                return null;
            }
        }

        // ì¥ë¹„ ì—°ê²° í•´ì œ
        async function disconnectDevice() {
            try {
                if (reader) {
                    await reader.cancel();
                    await reader.releaseLock();
                    reader = null;
                }
                
                if (writer) {
                    await writer.releaseLock();
                    writer = null;
                }
                
                if (serialPort) {
                    await serialPort.close();
                    serialPort = null;
                }
                
                updateConnectionStatus('disconnected', 'ì¥ë¹„ ì—°ê²° í•´ì œë¨');
                
            } catch (error) {
                logCommand(`ì—°ê²° í•´ì œ ì˜¤ë¥˜: ${error.message}`);
                console.error('Disconnect error:', error);
            }
        }

        // ëª…ë ¹ì–´ ì „ì†¡
        async function sendCommand(command) {
            if (!isConnected) {
                logCommand(`ì‹œë®¬ë ˆì´ì…˜: ${command}`);
                return 'OK';
            }

            try {
                logCommand(`ì „ì†¡: ${command}`);
                
                // ëª…ë ¹ì–´ ì „ì†¡ (\rë§Œ ì‚¬ìš© - tinySA í‘œì¤€)
                const data = new TextEncoder().encode(command + '\r');
                await writer.write(data);
                
                // ì‘ë‹µ ì½ê¸°
                const response = await readResponseWithTimeout(5000);
                logCommand(`ì‘ë‹µ: "${response}"`);
                
                return response;
                
            } catch (error) {
                logCommand(`ëª…ë ¹ì–´ ì˜¤ë¥˜: ${error.message}`);
                throw error;
            }
        }

        // íƒ€ì„ì•„ì›ƒì´ ìˆëŠ” ì‘ë‹µ ì½ê¸°
        async function readResponseWithTimeout(timeoutMs = 5000) {
            return new Promise(async (resolve, reject) => {
                let response = '';
                let timeoutId;
                
                const timeout = setTimeout(() => {
                    reject(new Error('ì‘ë‹µ ì‹œê°„ ì´ˆê³¼'));
                }, timeoutMs);
                
                try {
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        
                        const text = new TextDecoder().decode(value);
                        response += text;
                        
                        // ë‹¤ì–‘í•œ í”„ë¡¬í”„íŠ¸ íŒ¨í„´ í™•ì¸
                        if (response.includes('ch>') || 
                            response.includes('Ch>') || 
                            response.includes('CH>') ||
                            response.endsWith('> ') ||
                            response.endsWith('>')) {
                            break;
                        }
                        
                        // ë„ˆë¬´ ê¸´ ì‘ë‹µ ë°©ì§€
                        if (response.length > 10000) {
                            break;
                        }
                    }
                    
                    clearTimeout(timeout);
                    
                    // í”„ë¡¬í”„íŠ¸ ì œê±° ë° ì •ë¦¬
                    const cleaned = response
                        .replace(/ch>/gi, '')
                        .replace(/>/g, '')
                        .replace(/\r/g, '')
                        .trim();
                        
                    resolve(cleaned);
                    
                } catch (error) {
                    clearTimeout(timeout);
                    reject(error);
                }
            });
        }

        // ì‘ë‹µ ì½ê¸° (ë ˆê±°ì‹œ - í˜¸í™˜ì„±ìš©)
        async function readResponse() {
            return await readResponseWithTimeout(5000);
        }

        // ì‹¤ì œ ì¥ë¹„ì—ì„œ ìŠ¤í™íŠ¸ëŸ¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function getHardwareSpectrum() {
            try {
                const startFreq = parseFloat(document.getElementById('startFreq').value) * 1e6; // MHz to Hz
                const stopFreq = parseFloat(document.getElementById('stopFreq').value) * 1e6;
                const points = parseInt(document.getElementById('scanPoints').value);

                logCommand('í•˜ë“œì›¨ì–´ ìŠ¤í™íŠ¸ëŸ¼ ì¸¡ì • ì‹œì‘...');

                // ìŠ¤ìœ„í”„ ì„¤ì •
                await sendCommandSafe(`sweep start ${Math.floor(startFreq)}`);
                await sleep(200);
                await sendCommandSafe(`sweep stop ${Math.floor(stopFreq)}`);
                await sleep(200);

                // ìŠ¤ìº” í¬ì¸íŠ¸ ì„¤ì • (tinySAëŠ” ìë™ìœ¼ë¡œ ì¡°ì •ë  ìˆ˜ ìˆìŒ)
                logCommand(`ì£¼íŒŒìˆ˜ ë²”ìœ„: ${startFreq/1e6} - ${stopFreq/1e6} MHz`);

                // ìŠ¤ìº” ì‹¤í–‰ ë° ì™„ë£Œ ëŒ€ê¸°
                await sendCommandSafe('resume');
                await sleep(1000); // ìŠ¤ìº” ì™„ë£Œ ëŒ€ê¸°

                // ì£¼íŒŒìˆ˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const freqResponse = await sendCommandSafe('frequencies');
                if (!freqResponse) {
                    throw new Error('ì£¼íŒŒìˆ˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                // ìŠ¤í™íŠ¸ëŸ¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (Array 0 = ì‹ í˜¸ ê°•ë„)
                const dataResponse = await sendCommandSafe('data 0');
                if (!dataResponse) {
                    throw new Error('ìŠ¤í™íŠ¸ëŸ¼ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                // ë°ì´í„° íŒŒì‹±
                const freqLines = freqResponse.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && !isNaN(parseFloat(line)));
                    
                const dataLines = dataResponse.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && !isNaN(parseFloat(line)));

                logCommand(`íŒŒì‹±ëœ ë°ì´í„°: ì£¼íŒŒìˆ˜ ${freqLines.length}ê°œ, ì‹ í˜¸ ${dataLines.length}ê°œ`);

                if (freqLines.length === 0 || dataLines.length === 0) {
                    throw new Error('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                }

                // ë°ì´í„° ê¸¸ì´ ë§ì¶”ê¸°
                const minLength = Math.min(freqLines.length, dataLines.length);
                const freqs = freqLines.slice(0, minLength).map(line => parseFloat(line) / 1e6); // Hz to MHz
                const spectrum = dataLines.slice(0, minLength).map(line => parseFloat(line));

                logCommand(`ìµœì¢… ë°ì´í„°: ${freqs.length}ê°œ í¬ì¸íŠ¸`);

                return { frequencies: freqs, spectrum: spectrum };
                
            } catch (error) {
                logCommand(`í•˜ë“œì›¨ì–´ ìŠ¤ìº” ì˜¤ë¥˜: ${error.message}`);
                
                // ì˜¤ë¥˜ ì‹œ ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°ë¡œ ëŒ€ì²´
                logCommand('ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤...');
                return simulateSpectrum();
            }
        }

        // ì—°ê²° ì§„ë‹¨ ê¸°ëŠ¥
        async function diagnoseConnection() {
            if (!isConnected) {
                logCommand('ì¥ë¹„ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                return;
            }

            try {
                logCommand('=== ì—°ê²° ì§„ë‹¨ ì‹œì‘ ===');
                
                // 1. ê¸°ë³¸ í†µì‹  í…ŒìŠ¤íŠ¸
                logCommand('1. ê¸°ë³¸ í†µì‹  í…ŒìŠ¤íŠ¸...');
                await writer.write(new TextEncoder().encode('\r'));
                const basicResponse = await readResponseWithTimeout(2000);
                logCommand(`ê¸°ë³¸ ì‘ë‹µ: "${basicResponse}"`);

                // 2. ë²„ì „ ì •ë³´
                logCommand('2. ë²„ì „ ì •ë³´ í™•ì¸...');
                const version = await sendCommandSafe('version');
                logCommand(`ë²„ì „: ${version || 'ì •ë³´ ì—†ìŒ'}`);

                // 3. í˜„ì¬ ìƒíƒœ
                logCommand('3. í˜„ì¬ ìƒíƒœ í™•ì¸...');
                const freqs = await sendCommandSafe('frequencies');
                if (freqs) {
                    const freqCount = freqs.split('\n').filter(line => line.trim()).length;
                    logCommand(`í˜„ì¬ ì£¼íŒŒìˆ˜ í¬ì¸íŠ¸: ${freqCount}ê°œ`);
                }

                // 4. ê°„ë‹¨í•œ ë°ì´í„° í…ŒìŠ¤íŠ¸
                logCommand('4. ë°ì´í„° í…ŒìŠ¤íŠ¸...');
                const testData = await sendCommandSafe('data 0');
                if (testData) {
                    const dataCount = testData.split('\n').filter(line => line.trim()).length;
                    logCommand(`ë°ì´í„° í¬ì¸íŠ¸: ${dataCount}ê°œ`);
                }

                logCommand('=== ì§„ë‹¨ ì™„ë£Œ ===');
                
            } catch (error) {
                logCommand(`ì§„ë‹¨ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        function initChart() {
            const ctx = document.getElementById('spectrumChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ì‹ í˜¸ ê°•ë„ (dBm)',
                        data: [],
                        borderColor: '#4a6cf7',
                        backgroundColor: 'rgba(74, 108, 247, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.2,
                        pointRadius: 0,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'ì£¼íŒŒìˆ˜ (MHz)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'ì‹ í˜¸ ê°•ë„ (dBm)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const elementIndex = elements[0].index;
                            const frequency = frequencies[elementIndex];
                            const amplitude = spectrumData[elementIndex];
                            updateMarker(frequency, amplitude);
                        }
                    },
                    animation: {
                        duration: 500
                    }
                }
            });
        }

        // ì£¼íŒŒìˆ˜ ë°°ì—´ ìƒì„±
        function generateFrequencies(start, stop, points) {
            const step = (stop - start) / (points - 1);
            const freqs = [];
            for (let i = 0; i < points; i++) {
                freqs.push(start + i * step);
            }
            return freqs;
        }

        // ìŠ¤í™íŠ¸ëŸ¼ ë°ì´í„° ì‹œë®¬ë ˆì´ì…˜
        function simulateSpectrum() {
            const startFreq = parseFloat(document.getElementById('startFreq').value);
            const stopFreq = parseFloat(document.getElementById('stopFreq').value);
            const points = parseInt(document.getElementById('scanPoints').value);
            const noiseLevel = parseFloat(document.getElementById('noiseLevel').value);

            // ì‹ í˜¸ íŒŒë¼ë¯¸í„° ì½ê¸°
            const signal1Freq = parseFloat(document.getElementById('signal1Freq').value);
            const signal1Amp = parseFloat(document.getElementById('signal1Amp').value);
            const signal1Type = document.getElementById('signal1Type').value;

            const signal2Freq = parseFloat(document.getElementById('signal2Freq').value);
            const signal2Amp = parseFloat(document.getElementById('signal2Amp').value);
            const signal2Type = document.getElementById('signal2Type').value;

            frequencies = generateFrequencies(startFreq, stopFreq, points);
            spectrumData = [];

            for (let i = 0; i < frequencies.length; i++) {
                const freq = frequencies[i];
                let amplitude = noiseLevel + (Math.random() - 0.5) * 10;

                // ì‹ í˜¸ 1 ì¶”ê°€
                if (signal1Freq >= startFreq && signal1Freq <= stopFreq) {
                    const signal1Component = calculateSignalComponent(freq, signal1Freq, signal1Amp, signal1Type);
                    amplitude = combineSignals(amplitude, signal1Component);
                }

                // ì‹ í˜¸ 2 ì¶”ê°€
                if (signal2Freq >= startFreq && signal2Freq <= stopFreq) {
                    const signal2Component = calculateSignalComponent(freq, signal2Freq, signal2Amp, signal2Type);
                    amplitude = combineSignals(amplitude, signal2Component);
                }

                spectrumData.push(amplitude);
            }

            return { frequencies, spectrum: spectrumData };
        }

        // ì‹ í˜¸ ì»´í¬ë„ŒíŠ¸ ê³„ì‚°
        function calculateSignalComponent(currentFreq, signalFreq, signalAmp, signalType) {
            const freqDiff = Math.abs(currentFreq - signalFreq);
            let component = -100; // ê¸°ë³¸ ë‚®ì€ ê°’

            switch (signalType) {
                case 'sine':
                    if (freqDiff < 5) {
                        component = signalAmp - (freqDiff * freqDiff * 2);
                    }
                    break;
                case 'square':
                    if (freqDiff < 5) {
                        component = signalAmp - (freqDiff * freqDiff * 1.5);
                    }
                    // ê³ ì¡°íŒŒ ì¶”ê°€
                    for (let harmonic = 3; harmonic <= 9; harmonic += 2) {
                        const harmonicFreq = signalFreq * harmonic;
                        const harmonicDiff = Math.abs(currentFreq - harmonicFreq);
                        if (harmonicDiff < 2) {
                            const harmonicAmp = signalAmp - 20 * Math.log10(harmonic) - harmonicDiff * 10;
                            component = combineSignals(component, harmonicAmp);
                        }
                    }
                    break;
                case 'noise':
                    component = signalAmp + (Math.random() - 0.5) * 20;
                    break;
            }

            return component;
        }

        // ì‹ í˜¸ ê²°í•© (dB ìŠ¤ì¼€ì¼)
        function combineSignals(signal1_dB, signal2_dB) {
            const power1 = Math.pow(10, signal1_dB / 10);
            const power2 = Math.pow(10, signal2_dB / 10);
            const totalPower = power1 + power2;
            return 10 * Math.log10(totalPower);
        }

        // ìŠ¤ìº” ì‹œì‘
        async function startScan() {
            if (isScanning) return;
            
            isScanning = true;
            document.getElementById('statusDisplay').textContent = 'ìŠ¤ìº” ì¤‘...';
            
            try {
                const deviceMode = document.getElementById('deviceMode').value;
                let data;

                if (deviceMode === 'hardware' && isConnected) {
                    // ì‹¤ì œ í•˜ë“œì›¨ì–´ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    logCommand('í•˜ë“œì›¨ì–´ ìŠ¤ìº” ì‹œì‘...');
                    data = await getHardwareSpectrum();
                } else {
                    // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ìƒì„±
                    logCommand('ì‹œë®¬ë ˆì´ì…˜ ìŠ¤ìº” ì‹œì‘...');
                    
                    // ì˜¨ë„ ì‹œë®¬ë ˆì´ì…˜ ì—…ë°ì´íŠ¸
                    const temp = 25 + (Math.random() - 0.5) * 10;
                    document.getElementById('temperature').value = temp.toFixed(1);
                    
                    await new Promise(resolve => setTimeout(resolve, 1000)); // ì‹œë®¬ë ˆì´ì…˜ ì§€ì—°
                    data = simulateSpectrum();
                }
                
                // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                frequencies = data.frequencies;
                spectrumData = data.spectrum;
                
                chart.data.labels = data.frequencies.map(f => f.toFixed(1));
                chart.data.datasets[0].data = data.spectrum;
                chart.update();

                document.getElementById('statusDisplay').textContent = 
                    `ìŠ¤ìº” ì™„ë£Œ - ${data.frequencies.length}ê°œ í¬ì¸íŠ¸, ë²”ìœ„: ${data.frequencies[0].toFixed(1)} - ${data.frequencies[data.frequencies.length-1].toFixed(1)} MHz`;
                
                logCommand('ìŠ¤ìº” ì™„ë£Œ');
                
            } catch (error) {
                document.getElementById('statusDisplay').textContent = `ìŠ¤ìº” ì˜¤ë¥˜: ${error.message}`;
                logCommand(`ìŠ¤ìº” ì˜¤ë¥˜: ${error.message}`);
            } finally {
                isScanning = false;
            }
        }

        // ë§ˆì»¤ ì—…ë°ì´íŠ¸
        function updateMarker(frequency, amplitude) {
            document.getElementById('markerInfo').innerHTML = `
                <strong>ì£¼íŒŒìˆ˜:</strong> ${frequency.toFixed(2)} MHz<br>
                <strong>ì§„í­:</strong> ${amplitude.toFixed(1)} dBm
            `;
        }

        // CSV ë‹¤ìš´ë¡œë“œ
        function downloadCSV() {
            if (frequencies.length === 0 || spectrumData.length === 0) {
                alert('ë¨¼ì € ìŠ¤ìº”ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }

            let csvContent = "ì£¼íŒŒìˆ˜(MHz),ì‹ í˜¸ê°•ë„(dBm)\n";
            for (let i = 0; i < frequencies.length; i++) {
                csvContent += `${frequencies[i].toFixed(3)},${spectrumData[i].toFixed(2)}\n`;
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `spectrum_data_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ê³ ê¸‰ ì„¤ì • ì ìš©
        async function applyAdvancedSettings() {
            try {
                const outputLevel = document.getElementById('outputLevel').value;
                const outputMode = document.getElementById('outputMode').value;
                const inputMode = document.getElementById('inputMode').value;
                const rbw = document.getElementById('rbw').value;

                if (isConnected && document.getElementById('deviceMode').value === 'hardware') {
                    // ì‹¤ì œ í•˜ë“œì›¨ì–´ ì„¤ì •
                    await sendCommand(`level ${outputLevel}`);
                    await sendCommand(`output ${outputMode}`);
                    await sendCommand(`mode ${inputMode} input`);
                    
                    if (rbw === 'auto') {
                        await sendCommand('rbw auto');
                    } else {
                        await sendCommand(`rbw ${rbw}`);
                    }
                    
                    logCommand('í•˜ë“œì›¨ì–´ ì„¤ì • ì ìš© ì™„ë£Œ');
                } else {
                    // ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ
                    logCommand(`ì‹œë®¬ë ˆì´ì…˜: ì¶œë ¥ ë ˆë²¨ ${outputLevel}dBm, ì¶œë ¥ ${outputMode}, ì…ë ¥ ëª¨ë“œ ${inputMode}`);
                }
                
                document.getElementById('statusDisplay').textContent = 'ê³ ê¸‰ ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤';
                
            } catch (error) {
                logCommand(`ì„¤ì • ì ìš© ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // ì˜¨ë„ ì¸¡ì •
        async function getTemperature() {
            try {
                if (isConnected && document.getElementById('deviceMode').value === 'hardware') {
                    // ì‹¤ì œ í•˜ë“œì›¨ì–´ì—ì„œ ì˜¨ë„ ì½ê¸°
                    const response = await sendCommand('k'); // ì˜¨ë„ ëª…ë ¹ì–´
                    const temp = parseFloat(response);
                    if (!isNaN(temp)) {
                        document.getElementById('temperature').value = temp.toFixed(1);
                        logCommand(`í•˜ë“œì›¨ì–´ ì˜¨ë„: ${temp.toFixed(1)}Â°C`);
                    }
                } else {
                    // ì‹œë®¬ë ˆì´ì…˜ ì˜¨ë„
                    const temp = 25 + (Math.random() - 0.5) * 15;
                    document.getElementById('temperature').value = temp.toFixed(1);
                    logCommand(`ì‹œë®¬ë ˆì´ì…˜ ì˜¨ë„: ${temp.toFixed(1)}Â°C`);
                }
            } catch (error) {
                logCommand(`ì˜¨ë„ ì¸¡ì • ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            initChart();
            
            // ë¸Œë¼ìš°ì € ì½˜ì†”ì— ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
            console.log('=== tinySA ìŠ¤í™íŠ¸ëŸ¼ ë¶„ì„ê¸° ë””ë²„ê¹… ëª¨ë“œ ===');
            console.log('UI ë¡œê·¸ ì™¸ì— ì½˜ì†”ì—ì„œë„ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            console.log('ì—°ê²° ë¬¸ì œ ë°œìƒ ì‹œ ì´ ì½˜ì†” ë‚´ìš©ì„ ì°¸ê³ í•˜ì„¸ìš”.');
            console.log('');
            
            // ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
            if (!('serial' in navigator)) {
                document.getElementById('deviceMode').innerHTML = '<option value="simulation">ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ (Web Serial API ë¯¸ì§€ì›)</option>';
                logCommand('âŒ ê²½ê³ : ì´ ë¸Œë¼ìš°ì €ëŠ” Web Serial APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                logCommand('ğŸ”§ í•´ê²°ë°©ë²•: Chrome, Edge, Opera ë“±ì˜ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.');
                logCommand('ğŸ“‹ Chrome ë²„ì „ 89 ì´ìƒì´ í•„ìš”í•©ë‹ˆë‹¤.');
                
                console.error('Web Serial API not supported. Browser:', navigator.userAgent);
            } else {
                logCommand('âœ… Web Serial API ì§€ì›ë¨');
                logCommand('');
                logCommand('ğŸ“Œ === tinySA ì—°ê²° ê°€ì´ë“œ ===');
                logCommand('1ï¸âƒ£ Windows ì¥ì¹˜ ê´€ë¦¬ìì—ì„œ COM í¬íŠ¸ì˜ ë¹„íŠ¸/ì´ˆ í™•ì¸');
                logCommand('2ï¸âƒ£ í™•ì¸ëœ ë³´ë“œë ˆì´íŠ¸ë¥¼ ìœ„ "ë³´ë“œë ˆì´íŠ¸" ë©”ë‰´ì—ì„œ ì„ íƒ');
                logCommand('   â€¢ 9600 bps: ê°€ì¥ ì¼ë°˜ì ì¸ ì‹œìŠ¤í…œ ê¸°ë³¸ê°’');
                logCommand('   â€¢ 115200 bps: tinySA ê³µì¥ ê¸°ë³¸ê°’');
                logCommand('   â€¢ ìë™ ê°ì§€: í™•ì‹¤í•˜ì§€ ì•Šì„ ë•Œ ê¶Œì¥');
                logCommand('3ï¸âƒ£ tinySAë¥¼ ë°ì´í„° ì „ì†¡ìš© USB ì¼€ì´ë¸”ë¡œ PCì— ì—°ê²°');
                logCommand('4ï¸âƒ£ tinySA ì „ì›ì´ ì¼œì ¸ ìˆê³  ì •ìƒ í™”ë©´ì´ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸');
                logCommand('5ï¸âƒ£ "ì¥ë¹„ ëª¨ë“œ"ë¥¼ "ì‹¤ì œ ì¥ë¹„ ì—°ê²°"ë¡œ ì„ íƒ');
                logCommand('6ï¸âƒ£ "ì¥ë¹„ ì—°ê²°" ë²„íŠ¼ í´ë¦­');
                logCommand('7ï¸âƒ£ íŒì—…ì—ì„œ ì ì ˆí•œ í¬íŠ¸ ì„ íƒ (ë³´í†µ "USB Serial Device")');
                logCommand('8ï¸âƒ£ ì—°ê²° ì™„ë£Œ í›„ "ì—°ê²° ì§„ë‹¨"ìœ¼ë¡œ ìƒíƒœ í™•ì¸');
                logCommand('');
                logCommand('ğŸ’¡ ë³´ë“œë ˆì´íŠ¸ê°€ ë§ì§€ ì•Šìœ¼ë©´ ì—°ê²° ì‹¤íŒ¨!');
                logCommand('ğŸš¨ ì—°ê²° ì‹¤íŒ¨ ì‹œ: "ì „ì²´ ì§„ë‹¨" ë° "ì›ì‹œ ë°ì´í„° ëª¨ë‹ˆí„°" í™œìš©');
                logCommand('ğŸ”§ ê³ ê¸‰ ë””ë²„ê¹…: F12 â†’ Console íƒ­ì—ì„œ ìƒì„¸ ì˜¤ë¥˜ í™•ì¸');
                
                console.log('Web Serial API supported. Ready for tinySA connection.');
            }
            
            // ì—°ê²° í•´ì œ ê°ì§€
            if ('serial' in navigator) {
                navigator.serial.addEventListener('disconnect', (event) => {
                    if (event.target === serialPort) {
                        updateConnectionStatus('disconnected', 'ğŸ”Œ ì¥ë¹„ ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤ (USB ì¼€ì´ë¸” í™•ì¸)');
                        console.warn('tinySA disconnected unexpectedly');
                        serialPort = null;
                        reader = null;
                        writer = null;
                    }
                });
                
                // ê¸°ì¡´ í—ˆìš©ëœ í¬íŠ¸ í™•ì¸
                navigator.serial.getPorts().then(ports => {
                    if (ports.length > 0) {
                        logCommand(`ğŸ’¡ ê¸°ì¡´ í—ˆìš©ëœ í¬íŠ¸ ${ports.length}ê°œ ë°œê²¬ë¨`);
                        console.log('Previously authorized ports:', ports);
                    }
                }).catch(err => {
                    console.error('Error checking existing ports:', err);
                });
            }
            
            // ìë™ ìŠ¤ìº” (ì´ˆê¸° ë°ì´í„°)
            setTimeout(() => {
                startScan();
            }, 500);
            
            logCommand('ğŸš€ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
            console.log('tinySA Simulator initialized successfully');
        });

        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ì˜µì…˜)
        setInterval(() => {
            if (!isScanning) {
                // ì˜¨ë„ ë³€í™” ì‹œë®¬ë ˆì´ì…˜
                const currentTemp = parseFloat(document.getElementById('temperature').value);
                const newTemp = currentTemp + (Math.random() - 0.5) * 0.5;
                document.getElementById('temperature').value = newTemp.toFixed(1);
            }
        }, 5000);
    </script>
</body>
</html>
